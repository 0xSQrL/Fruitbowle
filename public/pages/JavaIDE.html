<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fruitbowle Java IDE</title>
    <script src="/public/javascripts/jquery-3.3.1.min.js"></script>
    <script src="/public/javascripts/basic_utils.js"></script>
    <script>
        function analyzeText(event){
        	let ideEdit = document.getElementById("ideEdit");
        	let key = event.key;
        	let selectedIndex = getSelectionIndex(ideEdit);
            if (event.keyCode === 9) { // tab key
                event.preventDefault();
                ideEdit.innerHTML = insertAt(ideEdit.innerText, selectedIndex, `&nbsp&nbsp&nbsp&nbsp`);
            }
			ideEdit.innerHTML = insertAt(ideEdit.innerText, selectedIndex, autoCompleteBrackets(key));
			setSelectionIndex(ideEdit, selectedIndex);
        }

        function moveCursor(order){

            let ideEdit = document.getElementById("ideEdit");

            let selectedIndex = getSelectionIndex(ideEdit);

            setSelectionIndex(ideEdit, selectedIndex + order);
        }

        function autoCompleteBrackets(key){
        	switch (key) {
				case '{':
					return '}';
				case '[':
					return ']';
				case '(':
					return ')';
                default:
                	return '';
			}

        }

		function insertAt(text, index, insertion){
			let start = text.substring(0, index);
			let end = text.substring(index, text.length);
			return `${start}${insertion}${end}`;
		}

		function getSelectionIndex(element){
			element.focus();
			let _range = document.getSelection().getRangeAt(0);
			let range = _range.cloneRange();
			range.selectNodeContents(element);
			range.setStart(_range.startContainer, _range.startOffset);
			return _range.endOffset;
		}

		function setSelectionIndex(element, position){
            let selection = document.getSelection();
            let selectionRange = selection.getRangeAt(0);
            let range = document.createRange();
            console.log(`${position} ${selectionRange.endOffset}`);
			range.setStart(element, position);
			range.collapse(true);
			selection.removeAllRanges();
			selection.addRange(range);

		}

        function init(){

			let ideEdit = document.getElementById("ideEdit");
			ideEdit.innerText = "Test 123";
        }

        function postCode(){
            send_api_call("/api/java/load", "GET", {}, {
                success: function (data) {
                    alert(data.files.length)
                },
                error: function (data) {
                    alert('Error');
                }
            });
        }

        function File(filename){
            this.filename = filename;
            this.contents = "";
        }
    </script>
    <style>
        .ideEdit{
            width: 80%;
            min-height: 10rem;
            border: black 1px solid;
            padding: 1rem;
        }
    </style>
</head>
<body spellcheck="false"  onload="init()">
<div contenteditable="true" class="ideEdit" onkeydown="analyzeText(event)" id="ideEdit"></div>
<button onclick="moveCursor(-1)">&lt</button><button onclick="moveCursor(1)">&gt</button><br>
<button onclick="postCode()">Post</button>
</body>
</html>